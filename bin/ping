#!/usr/bin/env python3
"""
ping - Test connectivity with AI providers.

Usage:
    ping <provider> [--session-file FILE]

Providers:
    codex, claude
"""

import sys
import os
import argparse
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))

from compat import setup_windows_encoding
setup_windows_encoding()


# Provider to communicator module and class mapping
PROVIDER_COMMS = {
    "codex": ("codex_comm", "CodexCommunicator"),
    "claude": ("claude_comm", "ClaudeCommunicator"),
}


def _usage():
    print("Usage: ping <provider> [--session-file FILE]", file=sys.stderr)
    print("", file=sys.stderr)
    print("Providers:", file=sys.stderr)
    print("  codex, claude", file=sys.stderr)


def main():
    if len(sys.argv) < 2:
        _usage()
        return 1

    provider = sys.argv[1].lower()

    if provider in ("-h", "--help"):
        _usage()
        return 0

    if provider not in PROVIDER_COMMS:
        print(f"[ERROR] Unknown provider: {provider}", file=sys.stderr)
        print(f"[ERROR] Available: {', '.join(PROVIDER_COMMS.keys())}", file=sys.stderr)
        return 1

    # Parse remaining arguments
    parser = argparse.ArgumentParser(prog=f"ping {provider}", add_help=False)
    parser.add_argument("--session-file", dest="session_file", default=None)
    args, _ = parser.parse_known_args(sys.argv[2:])

    if args.session_file:
        os.environ["CCB_SESSION_FILE"] = str(args.session_file)

    # Import and instantiate the communicator
    module_name, class_name = PROVIDER_COMMS[provider]
    try:
        module = __import__(module_name)
        comm_class = getattr(module, class_name)
        comm = comm_class()
        healthy, message = comm.ping(display=False)
        print(message)
        return 0 if healthy else 1
    except ImportError as e:
        print(f"[ERROR] Module import failed: {e}", file=sys.stderr)
        return 1
    except Exception as e:
        print(f"[ERROR] {provider.capitalize()} connectivity test failed: {e}", file=sys.stderr)
        return 1


if __name__ == "__main__":
    sys.exit(main())
