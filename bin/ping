#!/usr/bin/env python3
"""
ping - Test connectivity with AI providers.

Usage:
    ping <provider> [--session-file FILE]

Providers:
    codex, claude
"""

from __future__ import annotations

import argparse
import json
import sys
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))

from compat import setup_windows_encoding
setup_windows_encoding()

from codex_session import CodexProjectSession, load_project_session as load_codex_session
from claude_session import ClaudeProjectSession, load_project_session as load_claude_session

def _usage():
    print("Usage: ping <provider> [--session-file FILE]", file=sys.stderr)
    print("", file=sys.stderr)
    print("Providers:", file=sys.stderr)
    print("  codex, claude", file=sys.stderr)

def _read_json(path: Path) -> dict:
    try:
        raw = path.read_text(encoding="utf-8-sig", errors="replace")
        data = json.loads(raw)
        return data if isinstance(data, dict) else {}
    except Exception:
        return {}


def _is_inactive(data: dict) -> bool:
    return isinstance(data, dict) and data.get("active") is False


def _load_session(provider: str, *, work_dir: Path, session_file: Path | None) -> tuple[object | None, str | None]:
    if session_file is not None:
        data = _read_json(session_file)
        if not data:
            return None, f"Session file unreadable or empty: {session_file}"
        if _is_inactive(data):
            return None, f"Session is inactive: {session_file}"
        if provider == "codex":
            return CodexProjectSession(session_file=session_file, data=data), None
        return ClaudeProjectSession(session_file=session_file, data=data), None

    if provider == "codex":
        session = load_codex_session(work_dir)
    else:
        session = load_claude_session(work_dir)

    if not session:
        return None, f"No active {provider} session found for this directory. Run `ccb {provider}` first."

    if _is_inactive(getattr(session, "data", {})):
        return None, f"Session is inactive: {getattr(session, 'session_file', '')}"

    return session, None


def main():
    if len(sys.argv) < 2:
        _usage()
        return 1

    provider = sys.argv[1].lower()

    if provider in ("-h", "--help"):
        _usage()
        return 0

    if provider not in ("codex", "claude"):
        print(f"[ERROR] Unknown provider: {provider}", file=sys.stderr)
        print("[ERROR] Available: codex, claude", file=sys.stderr)
        return 1

    # Parse remaining arguments
    parser = argparse.ArgumentParser(prog=f"ping {provider}", add_help=False)
    parser.add_argument("--session-file", dest="session_file", default=None)
    args, _ = parser.parse_known_args(sys.argv[2:])

    session_file: Path | None = None
    if args.session_file:
        session_file = Path(args.session_file).expanduser()
        if not session_file.exists():
            print(f"[ERROR] Session file not found: {session_file}", file=sys.stderr)
            return 1

    session, err = _load_session(provider, work_dir=Path.cwd(), session_file=session_file)
    if not session:
        print(f"[ERROR] {err}", file=sys.stderr)
        return 1

    try:
        ok, pane_or_err = session.ensure_pane()
    except Exception as e:
        print(f"[ERROR] {provider.capitalize()} connectivity test failed: {e}", file=sys.stderr)
        return 1

    if ok:
        print(f"OK ({provider} pane {pane_or_err})")
        return 0

    print(f"[ERROR] {provider.capitalize()} pane not reachable: {pane_or_err}", file=sys.stderr)
    return 1


if __name__ == "__main__":
    sys.exit(main())
