#!/usr/bin/env python3
"""
oping - Test OpenCode connectivity
"""

import sys
import os
import argparse
from pathlib import Path

script_dir = Path(__file__).resolve().parent
lib_dir = script_dir.parent / "lib"
sys.path.insert(0, str(lib_dir))
from compat import setup_windows_encoding

setup_windows_encoding()

try:
    from opencode_comm import OpenCodeCommunicator

    def main() -> int:
        try:
            parser = argparse.ArgumentParser(prog="oping", add_help=True)
            parser.add_argument("--session-file", dest="session_file", default=None, help="Path to .opencode-session (or .ccb_config/.opencode-session)")
            args = parser.parse_args()
            if args.session_file:
                os.environ["CCB_SESSION_FILE"] = str(args.session_file)
            comm = OpenCodeCommunicator()
            healthy, message = comm.ping(display=False)
            print(message)
            return 0 if healthy else 1
        except Exception as exc:
            print(f"[ERROR] OpenCode connectivity test failed: {exc}")
            return 1

    if __name__ == "__main__":
        sys.exit(main())

except ImportError as exc:
    print(f"[ERROR] Module import failed: {exc}")
    sys.exit(1)
